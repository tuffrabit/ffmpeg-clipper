<!doctype html>
<html lang="en">
  <head>
    <title>ffmpeg-clipper {{.HomeDirectory}}</title>
    <link rel="shortcut icon" href="#">
    <style>
        .error {
            background-color: tomato;
        }
    </style>
  </head>
  <body>
    <h2>{{.HomeDirectory}}</h2>
    <div style="display: flex;flex-direction: column;">
        <div style="display: flex;flex-direction: row;gap: 20px">
            <div style="display: flex;flex-direction: column;gap: 10px;max-width: 550px">
                <button onclick="getAvailableVideos()">Refresh Available Videos</button>
                <div>
                    <label for="available-videos">Available Videos</label>
                    <select id="available-videos" name="available-videos" size="" style="max-height: 200px;"></select> 
                </div>
                <button onclick="playVideo()">Play Video</button>
                <div>
                    <label for="alternate-player">Alternate Player</label>
                    <input id="alternate-player" type="text" style="width: 100%" /> 
                </div>
                <p>Full path to valid video player executable. ffmpeg-clipper assumes the alternate player executable simply takes a video file path as its main argument.</p>
            </div>
            <div style="display: flex;flex-direction: column;gap: 10px">
                <span>
                    <label for="start-time">Start (hh:mm:ss)</label>
                    <input id="start-time" type="text" value="00:00:00" onchange="validateTime(event)" />
                </span>
                <span>
                    <label for="end-time">End (hh:mm:ss)</label>
                    <input id="end-time" type="text" value="00:00:00" onchange="validateTime(event)" />
                </span>
                <span>
                    <label for="scale-factor">Scale Down Factor</label>
                    <input id="scale-factor" type="text" value="2.666" onchange="validateFloat(event, .01, 100);calculateScale();" />
                </span>
                <span>
                    <label for="encoding-preset">Encoding Preset</label>
                    <select id="encoding-preset" name="encoding-preset">
                        <option value="ultrafast">ultrafast</option>
                        <option value="superfast">superfast</option>
                        <option value="veryfast">veryfast</option>
                        <option value="faster">faster</option>
                        <option value="fast">fast</option>
                        <option value="medium" selected="selected">medium</option>
                        <option value="slow">slow</option>
                        <option value="slower">slower</option>
                        <option value="veryslow">veryslow</option>
                    </select> 
                </span>
                <span>
                    <label for="quality-target">Quality Target (0 to 51)</label>
                    <input id="quality-target" type="text" value="24" onchange="validateFloat(event, 0, 51)" />
                </span>
                <span>
                    <label for="saturation">Saturation (0.0 to 3.0)</label>
                    <input id="saturation" type="text" value="1" onchange="validateFloat(event, 0, 3)" />
                </span>
                <span>
                    <label for="contrast">Contrast (-1000.0 to 1000.0)</label>
                    <input id="contrast" type="text" value="1" onchange="validateFloat(event, -1000, 1000)" />
                </span>
                <span>
                    <label for="brightness">Brightness (-1.0 to 1.0)</label>
                    <input id="brightness" type="text" value="0" onchange="validateFloat(event, -1, 1)" />
                </span>
                <span>
                    <label for="gamma">Gamma (0.1 to 10.0)</label>
                    <input id="gamma" type="text" value="1" onchange="validateFloat(event, .1, 10)" />
                </span>
                <span>
                    <label for="play-after">Play clip when done</label>
                    <input id="play-after" type="checkbox" />
                </span>
                <button onclick="clipVideo()">Clip</button>
            </div>
            <div style="display: flex;flex-direction: column;gap: 10px">
                <span>
                    <label for="profiles">Profiles</label>
                    <select id="profiles" name="profiles" size="0" style="max-height: 135px;" onchange="profileSelected()"></select> 
                </span>
                <span style="display: flex;flex-direction: row;gap: 7px">
                    <button onclick="saveProfile()">Save</button>
                    <button onclick="saveNewProfile()">Save New</button>
                    <button onclick="deleteProfile()">Delete</button>
                </span>
                <h3>Scale Calculator</h3>
                <span>
                    <label for="source-width">Source Width</label>
                    <input id="source-width" type="text" value="2560" onchange="validateInt(event, 0, 8192);calculateScale()" />
                </span>
                <span>
                    <label for="source-height">Source Height</label>
                    <input id="source-height" type="text" value="1440" onchange="validateInt(event, 0, 8192);calculateScale()" />
                </span>
                <span>
                    <label for="new-size">New Size</label>
                    <input id="new-size" type="text" readonly />
                </span>
            </div>
        </div>
        <div style="display: flex;flex-direction: column;margin: 13px 17px 0 17px">
            <label for="output">Messages</label>
            <button onclick="clearOutput()" style="width: 81px;">Clear</button>
            <textarea id="output" style="width: 100%;" rows="15" readonly></textarea>
        </div>
    </div>
    <script>
        function getBasicSettingsPayload() {
            let encodingPresetDropdown = document.getElementById("encoding-preset");
            let payload = null;

            try {
                payload = {
                    "scaleFactor": parseFloat(document.getElementById("scale-factor").value),
                    "encodingPreset": encodingPresetDropdown.options[encodingPresetDropdown.selectedIndex].value,
                    "qualityTarget": parseInt(document.getElementById("quality-target").value),
                    "saturation": parseFloat(document.getElementById("saturation").value),
                    "contrast": parseFloat(document.getElementById("contrast").value),
                    "brightness": parseFloat(document.getElementById("brightness").value),
                    "gamma": parseFloat(document.getElementById("gamma").value),
                    "playAfter": document.getElementById("play-after").checked
                };
            } catch(err) {
                addOutput("Could not create request payload, err: " + err);
            }

            return payload;
        }

        function playVideo() {
            let dropdown = document.getElementById("available-videos");
            let video = dropdown.options[dropdown.selectedIndex];

            if (video) {
                let payload = {
                    "video": video.value,
                    "alternatePlayer": document.getElementById("alternate-player").value
                };

                fetch('{{.FrontendUri}}/playvideo/', {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(responseJson) {
                    if (responseJson.error) {
                        addOutput(responseJson.error);
                    }
                });
            }
        }

        function clipVideo() {
            if (document.getElementsByClassName("error").length > 0) {
                addOutput("You have clip settings errors, fix them!");
                return;
            }

            let videoDropdown = document.getElementById("available-videos");
            let selectedVideo = videoDropdown.options[videoDropdown.selectedIndex];

            if (!selectedVideo) {
                addOutput("You don't have a video selected.");
                return;
            }

            let payload = getBasicSettingsPayload();
            payload.video = selectedVideo.value;
            payload.startTime = document.getElementById("start-time").value;
            payload.endTime = document.getElementById("end-time").value;
            payload.alternatePlayer = document.getElementById("alternate-player").value;

            fetch('{{.FrontendUri}}/clipvideo', {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(responseJson) {
                if (responseJson.error) {
                    addOutput(responseJson.error);
                } else {
                    addOutput(responseJson.newVideoName + " was created!");
                    getAvailableVideos();
                }
            });
        }

        function getAvailableVideos() {
            fetch('{{.FrontendUri}}/getavailablevideos')
            .then(function(response) {
                return response.json();
            })
            .then(function(responseJson) {
                if (responseJson.error) {
                    addOutput(responseJson.error);
                } else {
                    let dropdown = document.getElementById("available-videos");
                    dropdown.innerHTML = "";

                    for (let i = 0; i < responseJson.AvailableVideos.length; i++) {
                        let option = document.createElement("option");
                        option.text = responseJson.AvailableVideos[i];
                        option.value = responseJson.AvailableVideos[i];
                        dropdown.add(option);
                    }

                    dropdown.setAttribute('size', responseJson.AvailableVideos.length);
                }
            });
        }

        function getConfig() {
            let dropdown = document.getElementById("profiles");
            let selected = "";
            let selectedOption = dropdown.options[dropdown.selectedIndex];

            if (selectedOption) {
                selected = selectedOption.value;
            }

            fetch('{{.FrontendUri}}/getconfig')
            .then(function(response) {
                return response.json();
            })
            .then(function(responseJson) {
                if (responseJson.error) {
                    addOutput(responseJson.error);
                } else {
                    let dropdown = document.getElementById("profiles");
                    dropdown.innerHTML = "";

                    for (let i = 0; i < responseJson.profiles.length; i++) {
                        let option = document.createElement("option");
                        option.text = responseJson.profiles[i].profileName;
                        option.value = responseJson.profiles[i].profileName;

                        if (selected === responseJson.profiles[i].profileName) {
                            option.selected = "selected";
                        }

                        dropdown.add(option);
                    }

                    dropdown.setAttribute('size', responseJson.profiles.length);
                    profiles = responseJson.profiles;
                    profileSelected();
                }
            });
        }

        function saveProfile() {
            let profile = getSelectedProfile();

            if (profile) {
                let confirmed = confirm("Are you sure?");

                if (confirmed) {
                    doSaveProfile(profile.profileName);
                }
            }
        }

        function saveNewProfile() {
            let profileName = prompt("Profile Name?");

            if (profileName) {
                let confirmed = confirm("Are you sure?");

                if (confirmed) {
                    doSaveProfile(profileName);
                }
            }
        }

        function deleteProfile() {
            let profile = getSelectedProfile();

            if (profile) {
                let confirmed = confirm("Are you sure?");

                if (confirmed) {
                    let payload = {"profileName": profile.profileName};
                    
                    fetch('{{.FrontendUri}}/deleteprofile', {
                        method: "DELETE",
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(responseJson) {
                        if (responseJson.error) {
                            addOutput(responseJson.error);
                        } else {
                            addOutput(profile.profileName + " was deleted!");
                            getConfig();
                        }
                    });
                }
            }
        }

        function doSaveProfile(profileName) {
            if (profileName) {
                let payload = getBasicSettingsPayload();
                payload.profileName = profileName;
                payload.sourceWidth = parseInt(document.getElementById("source-width").value);
                payload.sourceHeight = parseInt(document.getElementById("source-height").value);
                payload.alternatePlayer = document.getElementById("alternate-player").value;

                fetch('{{.FrontendUri}}/saveprofile', {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(responseJson) {
                    if (responseJson.error) {
                        addOutput(responseJson.error);
                    } else {
                        addOutput(profileName + " was saved!");
                        getConfig();
                    }
                });
            }
        }

        function getSelectedProfile() {
            let dropdown = document.getElementById("profiles");
            let selectedOption = dropdown.options[dropdown.selectedIndex];
            let profile = null;

            if (selectedOption) {
                let selected = dropdown.options[dropdown.selectedIndex].value;

                for (let i = 0; i < profiles.length; i++) {
                    if (selected === profiles[i].profileName) {
                        profile = profiles[i];
                        break;
                    }
                }
            }

            return profile;
        }

        function profileSelected() {
            let profile = getSelectedProfile();

            if (profile) {
                document.getElementById("scale-factor").value = profile.scaleFactor;
                document.getElementById("encoding-preset").value = profile.encodingPreset;
                document.getElementById("quality-target").value = profile.qualityTarget;
                document.getElementById("saturation").value = profile.saturation;
                document.getElementById("contrast").value = profile.contrast;
                document.getElementById("brightness").value = profile.brightness;
                document.getElementById("gamma").value = profile.gamma;
                document.getElementById("play-after").checked = profile.playAfter;
                document.getElementById("source-width").value = profile.sourceWidth;
                document.getElementById("source-height").value = profile.sourceHeight;
                document.getElementById("alternate-player").value = profile.alternatePlayer;
            }
        }

        function clearOutput() {
            document.getElementById("output").value = "";
        }

        function addOutput(message) {
            let output = document.getElementById("output");

            output.value = output.value + message + '\n';
        }

        function validateTime(event) {
            let value = event.target.value;

            if (typeof value !== "string") {
                event.target.classList.add("error");
                return;
            }

            let values = value.split(":");

            if (values.length !== 3) {
                event.target.classList.add("error");
                return;
            }

            for (let i = 0; i < values.length; i++) {
                if (values[i].length !== 2) {
                    event.target.classList.add("error");
                    return;
                }

                if (values[i].includes('-')) {
                    event.target.classList.add("error");
                    return;
                }

                if (isNaN(values[i])) {
                    event.target.classList.add("error");
                    return;
                }
            }

            event.target.classList.remove("error");
            return;
        }

        function validateFloat(event, min, max) {
            let value = event.target.value;

            if (isNaN(value)) {
                event.target.classList.add("error");
                return;
            }

            if (value < min || value > max) {
                event.target.classList.add("error");
                return;
            }

            event.target.classList.remove("error");
            return;
        }

        function validateInt(event, min, max) {
            let value = event.target.value;

            if (isNaN(value) || value.includes('.')) {
                event.target.classList.add("error");
                return;
            }

            value = parseInt(value);

            if (!Number.isInteger(value)) {
                event.target.classList.add("error");
                return;
            }

            if (value < min || value > max) {
                event.target.classList.add("error");
                return;
            }

            event.target.classList.remove("error");
            return;
        }

        function calculateScale() {
            let scaleFactor = document.getElementById("scale-factor").value;
            let sourceWidth = document.getElementById("source-width").value;
            let sourceHeight = document.getElementById("source-height").value;
            let newWidth = sourceWidth / scaleFactor;
            let newHeight = sourceHeight / scaleFactor;
            let newSize = Math.trunc(newWidth) + "x" + Math.trunc(newHeight);

            document.getElementById("new-size").value = newSize;
        }

        let profiles;

        fetch('{{.FrontendUri}}/checkffmpeg')
            .then(function(response) {
                return response.json();
            })
            .then(function(responseJson) {
                let message = "";

                if (responseJson.FFmpegExists === false || responseJson.FFplayExists === false) {
                    message = 'Either FFmpeg or FFplay is missing, please download official releases and include them in the same directory as ffmpeg-clipper or add them to your OS PATH. https://ffmpeg.org/download.html';
                }

                if (message !== "") {
                    addOutput(message);
                } else {
                    getConfig();
                    getAvailableVideos();
                    calculateScale();
                }
            }
        );
    </script>
  </body>
</html>
